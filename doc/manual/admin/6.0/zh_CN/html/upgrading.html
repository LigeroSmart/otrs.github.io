<html><head>
<!-- otrs.github.io -->
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../../../../documentation.css">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="../../../../../documentation.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>
$(document).ready(function() {

    // Hint languages to prevent false matches (php for example).
    hljs.configure({
        languages: ['perl', 'javascript', 'xml', 'html', 'css', 'json', 'yaml']
    });

    // programlistings in manuals
    $('pre.programlisting').each(function(i, block) {
        hljs.highlightBlock(block);
    });
    // code snippets in Perl API docs
    $('.pod pre').addClass('perl').each(function(i, block) {
        hljs.highlightBlock(block);
    });
});</script>
<!-- otrs.github.io -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Upgrading OTRS from 5 to 6</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="OTRS 6 - Admin Manual"><link rel="up" href="installation.html" title="Chapter 2. 安装"><link rel="prev" href="installation-on-windows.html" title="在Windows上使用OTRS"><link rel="next" href="application.html" title="附加的应用程序"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Upgrading OTRS from 5 to 6</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="installation-on-windows.html">Prev</a> </td><th width="60%" align="center">Chapter 2. 安装</th><td width="20%" align="right"> <a accesskey="n" href="application.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="upgrading"></a>Upgrading OTRS from 5 to 6</h2></div></div></div><div class="toc"><dl class="toc"></dl></div><p>
    These instructions are for people upgrading OTRS from <span class="emphasis"><em>5</em></span>
to <span class="emphasis"><em>6</em></span> or from a <span class="emphasis"><em>5</em></span> to a later
patchlevel release <span class="emphasis"><em>5</em></span> and applies both for RPM and
source code (tarball) upgrades.
    </p><p>
    If you are running a lower version of OTRS you have to follow the upgrade
path to 5 first
(1.1-&gt;1.2-&gt;1.3-&gt;2.0-&gt;2.1-&gt;2.2-&gt;2.3-&gt;2.4-&gt;3.0-&gt;3.1-&gt;3.2-&gt;3.3-&gt;4-&gt;5)! You need
to perform a full upgrade to every version in between, including database
changes and the upgrading Perl script.
    </p><p>
    请注意：如果你从OTRS 2.2之前的版本升级，还需要参照<a class="ulink" href="http://bugs.otrs.org/show_bug.cgi?id=6798" target="_top">执行额外的步骤</a>。
    </p><p>
    Within a single minor version you can skip patch level releases if you want
to upgrade. For instance you can upgrade directly from OTRS 6 patchlevel 2
to version 6 patchlevel 6. If you need to do such a "patch level upgrade",
you should skip steps 6 and XXXXX.
    </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
            Please note that you need at least Perl 5.16 to run OTRS 6. If your system
has an older Perl version, you need to update it first before updating OTRS.
        </p></div><p>
    强烈建议在一台独立的测试主机上先进行升级测试。
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.8"></a>步骤1：停止所有相关的服务</h3></div></div></div><p>
        请确保没有任何运行中的服务或CRON计划任务还在试图访问OTRS。取决于你的服务配置，下面是一个例子：
        </p><p>
            </p><pre class="screen">
shell&gt; /etc/init.d/cron stop
shell&gt; /etc/init.d/postfix stop
shell&gt; /etc/init.d/apache stop
            </pre><p>
        </p><p>
        取决于从个哪个版本升级，按以下顺序停止OTRS CRON计划任务或守护进程：
        </p><p>
            </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; bin/Cron.sh stop
shell&gt; bin/otrs.Scheduler.pl -a stop
            </pre><p>
        </p><p>
        或
        </p><p>
            </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; bin/Cron.sh stop
shell&gt; bin/otrs.Daemon.pl stop
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.9"></a>步骤2：备份<code class="filename">/opt/otrs/</code>下面的所有内容</h3></div></div></div><p>
            </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="filename">Kernel/Config.pm</code></p></li><li class="listitem"><p><code class="filename">Kernel/Config/GenericAgent.pm</code>（仅供参考，这个文件不再需要）</p></li><li class="listitem"><p><code class="filename">Kernel/Config/Files/ZZZAuto.pm</code></p></li><li class="listitem"><p><code class="filename">var/*</code></p></li><li class="listitem"><p>当然还有数据库</p></li></ul></div><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.10"></a>步骤3：确保你已经备份了所有需要备份的 ;-)</h3></div></div></div><p></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.11"></a>步骤4：安装新版本（源码或RPM包）</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.4.7.11.2"></a>步骤4.1：使用源码：</h4></div></div></div><pre class="screen">
shell&gt; cd /opt
shell&gt; mv otrs otrs-old
shell&gt; tar -xzf otrs-x.x.x.tar.gz
shell&gt; mv otrs-x.x.x otrs
            </pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.11.2.3"></a>恢复原配置文件</h5></div></div></div><p>
                    </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="filename">Kernel/Config.pm</code></p></li><li class="listitem"><p><code class="filename">Kernel/Config/Files/ZZZAuto.pm</code></p></li></ul></div><p>
                </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.11.2.4"></a>恢复TicketCounter.log</h5></div></div></div><p>
                    为了让OTRS继续使用正确的工单编号，恢复文件<code class="filename">TicketCounter.log</code>到目录<code class="filename">/opt/otrs/var/log/</code>。这对于使用自动增长的工单编号特别有用。
                </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.11.2.5"></a>恢复工单数据</h5></div></div></div><p>
                    如果你配置OTRS将信件数据存储在文件系统，你必须恢复<code class="filename">article</code>目录到<code class="filename">/opt/otrs/var/</code>或在系统配置中指定的目录。
                </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.11.2.6"></a>Restore already installed default statistics</h5></div></div></div><p>
                    If you have additional packages with default statistics you have to restore
the stats xml files with the suffix <code class="filename">*.installed</code> to
<code class="filename">/opt/otrs/var/stats</code>.
                </p><pre class="screen">
shell&gt; cd OTRS-BACKUP/var/stats
shell&gt; cp *.installed /opt/otrs/var/stats
                </pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.11.2.7"></a>设置文件权限</h5></div></div></div><p>
                请执行
                </p><p>
                </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; bin/otrs.SetPermissions.pl
                </pre><p>
                </p><p>
                参数为你的系统设置需要的权限。例如：
                </p><p>
                </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>以OTRS用户运行WEB服务器：</p><p>
                </p><pre class="screen">
shell&gt; bin/otrs.SetPermissions.pl --web-group=otrs
                </pre><p>
                    </p></li><li class="listitem"><p>以wwwrun用户运行WEB服务器（如SUSE）：</p><p>
                </p><pre class="screen">
shell&gt; bin/otrs.SetPermissions.pl --web-group=wwwrun
                </pre><p>
                    </p></li><li class="listitem"><p>以apache用户运行WEB服务器（如Red Hat、CentOS）：</p><p>
                </p><pre class="screen">
shell&gt; bin/otrs.SetPermissions.pl --web-group=apache
                </pre><p>
                    </p></li><li class="listitem"><p>以www-data用户运行WEB服务器（如RDebian、 Ubuntu）：</p><p>
                </p><pre class="screen">
shell&gt; bin/otrs.SetPermissions.pl --web-group=www-data
                </pre><p>
                    </p></li></ul></div><p>

                </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.4.7.11.3"></a>步骤4.2：使用RPM包：</h4></div></div></div><p>
            </p><pre class="screen">
shell&gt; rpm -Uvh otrs-x.x.x.-01.rpm
            </pre><p>
            </p><p>
             在这种情况下通过RPM升级会自动恢复原配置文件并设置文件权限。
            </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.12"></a>步骤5：检查所需的Perl模块</h3></div></div></div><p>
        验证所有需要的Perl模块都已经安装到系统中，并安装可能缺失的模块。
        </p><p>
        </p><pre class="screen">
shell&gt; /opt/otrs/bin/otrs.CheckModules.pl
        </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.13"></a>步骤6：应用数据库修改</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.4.7.13.2"></a>步骤6.1：数据库schema升级</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.13.2.2"></a>MySQL：</h5></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                        注意：在MySQL升级过程中会在默认的表存储引擎创建新表。在MySQL 5.5中，新的默认存储引擎是
<code class="literal">InnoDB</code>。如果现有的表如‘users’表的表存储引擎是<code class="literal">MyISAM</code>，则在创建外键约束时会报错。在这种情况下，我们推荐将所有的表切换到<code class="literal">InnoDB</code>引擎，可通过执行命令行脚本切换：<span class="command"><strong>bin/otrs.Console.pl
Maint::Database::MySQL::InnoDBMigration</strong></span>。
                    </p></div><p>
                    任何与存储引擎相关的问题都可以通过命令检查出来：<code class="filename">bin/otrs.Console.pl
Maint::Database::Check</code>，所以请运行这个命令来检查可能的问题。
                </p><p>
                    </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; cat scripts/DBUpdate-to-6.mysql.sql | mysql -p -f -u root otrs
shell&gt; bin/otrs.Console.pl Maint::Database::Check
                    </pre><p>
                </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="id-1.4.7.13.2.3"></a>PostgreSQL：</h5></div></div></div><p>
                </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; cat scripts/DBUpdate-to-6.postgresql.sql | psql --set ON_ERROR_STOP=on --single-transaction otrs otrs
                </pre><p>
                </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="id-1.4.7.13.3"></a>步骤6.2：数据库迁移脚本</h4></div></div></div><p>
            Run the migration script (as user <code class="literal">otrs</code>, NOT as
<code class="literal">root</code>):
            </p><p>
            </p><pre class="screen">
shell&gt; scripts/DBUpdate-to-6.pl
            </pre><p>
            </p><p>
                The script will ask you to set a time zone for OTRS. It is very important
that you set the correct time zone (and keep it), otherwise date and time of
data added after the upgrade (tickets, articles, etc.) will be stored with a
different time zone than your existing data, leading to inconsistent data.
The script will suggest possible time zones based on your previous
configuration. In case you are not sure or made a mistake, you can change
the OTRS time zone after the upgrade via SysConfig setting
<code class="literal">OTRSTimeZone</code>.
            </p><p>
            如果这个脚本运行不正常，请不要继续升级，否则可能丢失数据。
            </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.14"></a>步骤7：刷新配置缓存并删除缓存</h3></div></div></div><p>
        Please run (as user <code class="literal">otrs</code>, <span class="emphasis"><em>not</em></span> as
<code class="literal">root</code>):
        </p><p>
        </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; bin/otrs.Console.pl Maint::Config::Rebuild
shell&gt; bin/otrs.Console.pl Maint::Cache::Delete
        </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.15"></a>步骤8：重启服务</h3></div></div></div><p>
        例如（取决于使用的服务，可能有差异）：
        </p><p>
        </p><pre class="screen">
shell&gt; /etc/init.d/apache start
shell&gt; /etc/init.d/postfix start
shell&gt; /etc/init.d/cron start
        </pre><p>
        </p><p>
        现有你可以登录到系统了。
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.16"></a>步骤9：检查安装的软件包</h3></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
                The OTRS packages of 5 are NOT compatible with OTRS 6, so you have to
perform a package upgrade!
            </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.17"></a>步骤10：启动OTRS守护进程</h3></div></div></div><p>
            The OTRS daemon is responsible for handling any asynchronous and recurring
tasks in OTRS.  The daemon also handles all GenericAgent jobs and must be
started from the <code class="literal">otrs</code> user.
        </p><p>
            </p><pre class="screen">
shell&gt; /opt/otrs/bin/otrs.Daemon.pl start
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.18"></a>Step 11: Update and activate cron jobs</h3></div></div></div><p>
            在<code class="filename">/opt/otrs/var/cron/*.dist</code>有两个默认的cron文件，它们的目的是确保OTRS守护进程正常运行。它们需要复制为没有“.dist”扩展名的新文件来激活。
        </p><p>
            </p><pre class="screen">
shell&gt; cd /opt/otrs/var/cron
shell&gt; for foo in *.dist; do cp $foo `basename $foo .dist`; done
            </pre><p>
        </p><p>
            要在系统中安排这些cron任务，你可以使用<code class="literal">otrs</code>运行脚本文件<code class="filename">Cron.sh</code>。
        </p><p>
            </p><pre class="screen">
shell&gt; /opt/otrs/bin/Cron.sh start
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.19"></a>Step 12: Update system registration (optional)</h3></div></div></div><p>
            如果系统已经注册到OTRS集团，强烈推荐这个时候更新注册信息。这将在OTRS集团的记录中更新注册的版本信息及其它变化了的信息，以便从云服务中获得更准确的信息。
        </p><p>
            如果你不手动更新注册信息，则会在定期连接时自动更新，但这可能是几个小时或几天后的事了，在此期间可能会从云服务得到一些错误信息比如：<span class="bold"><strong>OTRS Business Solution™</strong></span>更新。
        </p><p>
            </p><pre class="screen">
shell&gt; cd /opt/otrs/
shell&gt; bin/otrs.Console.pl Maint::Registration::UpdateSend --force
shell&gt; bin/otrs.Console.pl Maint::Cache::Delete
            </pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="id-1.4.7.20"></a>Step 13: Well done!</h3></div></div></div><p></p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="installation-on-windows.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="installation.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="application.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">在Windows上使用OTRS </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 附加的应用程序</td></tr></table></div></body></html>
